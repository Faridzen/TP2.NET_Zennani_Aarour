<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:Gauniv.Client.ViewModel"
             xmlns:dto="clr-namespace:Gauniv.Client.Dtos"
             x:Class="Gauniv.Client.Pages.MyGames"
             Title="Ma Bibliothèque"
             x:DataType="vm:MyGamesViewModel"
             BackgroundColor="#1b2838">

    <Grid RowDefinitions="Auto,Auto,*">
        
        <!-- Header -->
        <Grid Grid.Row="0" 
              Padding="20,15"
              BackgroundColor="#171a21">
            <Label Text="Ma Bibliothèque"
                   FontSize="28"
                   FontAttributes="Bold"
                   TextColor="#c7d5e0"/>
        </Grid>

        <!-- Status message -->
        <Label Grid.Row="1"
               Text="{Binding StatusMessage}"
               TextColor="#8f98a0"
               FontSize="13"
               Padding="20,10"
               IsVisible="{Binding StatusMessage, Converter={StaticResource IsNotNullConverter}}"/>

        <!-- Loading -->
        <ActivityIndicator Grid.Row="2"
                          IsRunning="{Binding IsLoading}"
                          IsVisible="{Binding IsLoading}"
                          Color="#66c0f4"
                          HeightRequest="60"/>

        <!-- Grille des jeux possédés -->
        <CollectionView Grid.Row="2"
                       ItemsSource="{Binding Games}"
                       SelectionMode="None"
                       Margin="15,10"
                       IsVisible="{Binding IsLoading, Converter={StaticResource InvertedBoolConverter}}">
            <CollectionView.ItemsLayout>
                <GridItemsLayout Orientation="Vertical" 
                                 Span="3" 
                                 HorizontalItemSpacing="15" 
                                 VerticalItemSpacing="20"/>
            </CollectionView.ItemsLayout>
            
            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="dto:GameDto">
                    <Frame Padding="0"
                           CornerRadius="8"
                           HasShadow="True"
                           BorderColor="#2a475e"
                           BackgroundColor="#16202d"
                           HeightRequest="380">
                        <Grid RowDefinitions="180,*,Auto">
                            <Grid.GestureRecognizers>
                                <TapGestureRecognizer 
                                    Command="{Binding Source={RelativeSource AncestorType={x:Type vm:MyGamesViewModel}}, Path=ViewGameDetailsCommand}"
                                    CommandParameter="{Binding .}"/>
                            </Grid.GestureRecognizers>
                            
                            <!-- Image du jeu -->
                            <Frame Grid.Row="0"
                                  Padding="0"
                                  CornerRadius="0"
                                  HasShadow="False"
                                  BackgroundColor="#2a475e"
                                  BorderColor="Transparent">
                                <Image Source="{Binding ImageUrl}"
                                      Aspect="AspectFill"
                                      HorizontalOptions="Fill"
                                      VerticalOptions="Fill"/>
                            </Frame>
                            
                            <!-- Info du jeu -->
                            <VerticalStackLayout Grid.Row="1" Padding="15" Spacing="8">
                                <!-- Titre -->
                                <Label Text="{Binding Title}"
                                      FontSize="18"
                                      FontAttributes="Bold"
                                      TextColor="#c7d5e0"
                                      LineBreakMode="TailTruncation"
                                      MaxLines="1"/>
                                
                                <!-- Catégories -->
                                <FlexLayout BindableLayout.ItemsSource="{Binding Categories}"
                                           Wrap="Wrap"
                                           AlignItems="Center">
                                    <BindableLayout.ItemTemplate>
                                        <DataTemplate x:DataType="x:String">
                                            <Label Text="{Binding .}"
                                                   FontSize="10"
                                                   TextColor="#66c0f4"
                                                   Margin="0,0,8,4"/>
                                        </DataTemplate>
                                    </BindableLayout.ItemTemplate>
                                </FlexLayout>

                                <!-- Description courte -->
                                <Label Text="{Binding Description}"
                                      FontSize="12"
                                      TextColor="#8f98a0"
                                      LineBreakMode="WordWrap"
                                      MaxLines="3"/>
                            </VerticalStackLayout>
                            
                            <!-- Footer: Bouton Télécharger -->
                            <Grid Grid.Row="2" 
                                  Padding="15,10" 
                                  BackgroundColor="#1b2838">
                                <Button Text="TÉLÉCHARGER"
                                       Command="{Binding Source={RelativeSource AncestorType={x:Type vm:MyGamesViewModel}}, Path=DownloadGameCommand}"
                                       CommandParameter="{Binding .}"
                                       BackgroundColor="#5c7e10"
                                       TextColor="White"
                                       FontAttributes="Bold"
                                       FontSize="14"
                                       Padding="0"
                                       CornerRadius="4"
                                       HeightRequest="40"
                                       HorizontalOptions="Fill"/>
                            </Grid>
                        </Grid>
                    </Frame>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>
    </Grid>
</ContentPage>