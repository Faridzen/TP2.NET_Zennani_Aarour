<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:Gauniv.Client.ViewModel"
             xmlns:dto="clr-namespace:Gauniv.Client.Dtos"
             x:Class="Gauniv.Client.Pages.AdminPage"
             x:Name="PageRoot"
             Title="Administration"
             BackgroundColor="#0a0c10">

    <Grid RowDefinitions="Auto,Auto,*">
        
        <!-- Header -->
        <Grid Grid.Row="0" HeightRequest="60" BackgroundColor="#111827">
            <Label Text="PANNEAU ADMIN"
                   FontSize="18"
                   FontAttributes="Bold"
                   TextColor="White"
                   HorizontalOptions="Center"
                   VerticalOptions="Center"/>
        </Grid>

        <!-- Status -->
        <Grid Grid.Row="1" BackgroundColor="#1e1b4b" Padding="5">
            <Label Text="{Binding StatusMessage}" 
                   TextColor="#10b981" 
                   HorizontalOptions="Center"
                   FontSize="10"/>
        </Grid>

        <!-- Main -->
        <Grid Grid.Row="2" ColumnDefinitions="*,*">
            
            <!-- Section Jeux -->
            <ScrollView Grid.Column="0">
                <VerticalStackLayout Padding="10" Spacing="15">
                    
                    <!-- Formulaire Jeu (En haut maintenant) -->
                    <Label Text="AJOUTER / MODIFIER UN JEU" FontAttributes="Bold" TextColor="#4f46e5" FontSize="14"/>
                    <Frame BackgroundColor="#111827" BorderColor="#4f46e5" Padding="15" CornerRadius="12">
                        <VerticalStackLayout Spacing="8">
                            <Entry Placeholder="Titre du jeu" Text="{Binding GameTitle}" BackgroundColor="#1f2937" TextColor="White"/>
                            <Editor Placeholder="Description" Text="{Binding GameDescription}" BackgroundColor="#1f2937" TextColor="White" HeightRequest="80"/>
                            
                            <Grid ColumnDefinitions="Auto,*" ColumnSpacing="10">
                                <Label Text="Prix :" VerticalOptions="Center" TextColor="Gray"/>
                                <Picker Grid.Column="1" ItemsSource="{Binding AvailablePrices}" SelectedItem="{Binding GamePrice}" BackgroundColor="#1f2937" TextColor="White"/>
                            </Grid>
                            
                            <Entry Placeholder="Image URL" Text="{Binding GameImageUrl}" BackgroundColor="#1f2937" TextColor="White"/>

                            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="10">
                                <Picker Grid.Column="0" 
                                        Title="Ajouter CatÃ©gorie"
                                        ItemsSource="{Binding Categories}"
                                        SelectedItem="{Binding SelectedCategoryToAdd}"
                                        ItemDisplayBinding="{Binding Name}"
                                        BackgroundColor="#1f2937"
                                        TextColor="White"/>
                                <Button Grid.Column="1" Text="+" Command="{Binding AddCategoryToGameCommand}" 
                                        BackgroundColor="#4f46e5" TextColor="White" WidthRequest="40"/>
                            </Grid>
                            <Label Text="{Binding GameCategoriesCsv}" TextColor="Gray" FontSize="10" MaxLines="1"/>

                            <!-- Executable Picking -->
                            <VerticalStackLayout Spacing="2">
                                <Label Text="ExÃ©cutable (.exe)" TextColor="#4f46e5" FontSize="11" FontAttributes="Bold"/>
                                <Grid ColumnDefinitions="*,Auto" ColumnSpacing="10">
                                    <Label Text="{Binding ExecutableFileName}" TextColor="Gray" FontSize="11" VerticalOptions="Center" LineBreakMode="TailTruncation"/>
                                    <Button Grid.Column="1" Text="Parcourir" Command="{Binding PickExecutableCommand}"
                                            BackgroundColor="#1f2937" TextColor="White" FontSize="11" Padding="10,5"/>
                                </Grid>
                            </VerticalStackLayout>
                            
                            <HorizontalStackLayout Spacing="10" HorizontalOptions="Center" Margin="0,10,0,0">
                                <Button Text="Enregistrer" Command="{Binding SaveGameCommand}" BackgroundColor="#4f46e5" TextColor="White" WidthRequest="120"/>
                                <Button Text="Vider" Command="{Binding PrepareNewGameCommand}" BackgroundColor="#374151" TextColor="White" WidthRequest="100"/>
                            </HorizontalStackLayout>
                        </VerticalStackLayout>
                    </Frame>

                    <Label Text="LISTE DES JEUX" FontAttributes="Bold" TextColor="White" Margin="0,10,0,0"/>
                    <VerticalStackLayout BindableLayout.ItemsSource="{Binding Games}">
                        <BindableLayout.ItemTemplate>
                            <DataTemplate x:DataType="dto:GameDto">
                                <Frame BackgroundColor="#1f2937" BorderColor="#374151" Padding="10" Margin="0,0,0,5">
                                    <Grid ColumnDefinitions="*,Auto,Auto">
                                        <VerticalStackLayout>
                                            <Label Text="{Binding Title}" TextColor="White" FontAttributes="Bold"/>
                                            <Label Text="{Binding Price, StringFormat='{0:C}'}" TextColor="#10b981" FontSize="11"/>
                                        </VerticalStackLayout>
                                        <Button Grid.Column="1" Text="âœŽ" 
                                                Command="{Binding Source={x:Reference PageRoot}, Path=BindingContext.SelectGameCommand}"
                                                CommandParameter="{Binding .}"
                                                BackgroundColor="Transparent" TextColor="White" WidthRequest="40" FontSize="18"/>
                                        <Button Grid.Column="2" Text="ðŸ—‘" 
                                                Command="{Binding Source={x:Reference PageRoot}, Path=BindingContext.DeleteGameCommand}"
                                                CommandParameter="{Binding .}"
                                                BackgroundColor="Transparent" TextColor="#ef4444" WidthRequest="40" FontSize="18"/>
                                    </Grid>
                                </Frame>
                            </DataTemplate>
                        </BindableLayout.ItemTemplate>
                    </VerticalStackLayout>
                </VerticalStackLayout>
            </ScrollView>

            <!-- Section CatÃ©gories -->
            <ScrollView Grid.Column="1" BackgroundColor="#111827">
                <VerticalStackLayout Padding="10" Spacing="10">
                    <Label Text="GESTION DES CATÃ‰GORIES" FontAttributes="Bold" TextColor="White"/>

                    <Frame BackgroundColor="#1f2937" BorderColor="#4f46e5" Padding="15">
                        <VerticalStackLayout Spacing="5">
                            <Entry Placeholder="Nom de la catÃ©gorie" Text="{Binding CategoryName}" BackgroundColor="#111827" TextColor="White"/>
                            <Button Text="Enregistrer" Command="{Binding SaveCategoryCommand}" BackgroundColor="#4f46e5" TextColor="White" Margin="0,5,0,0"/>
                        </VerticalStackLayout>
                    </Frame>

                    <VerticalStackLayout BindableLayout.ItemsSource="{Binding Categories}" Margin="0,10,0,0">
                        <BindableLayout.ItemTemplate>
                            <DataTemplate x:DataType="dto:CategoryDto">
                                <Frame BackgroundColor="#1f2937" BorderColor="#374151" Padding="10" Margin="0,0,0,5">
                                    <Grid ColumnDefinitions="*,Auto,Auto">
                                        <Label Text="{Binding Name}" TextColor="White" VerticalOptions="Center"/>
                                        <Button Grid.Column="1" Text="âœŽ" 
                                                Command="{Binding Source={x:Reference PageRoot}, Path=BindingContext.SelectCategoryCommand}"
                                                CommandParameter="{Binding .}"
                                                BackgroundColor="Transparent" TextColor="White" WidthRequest="40"/>
                                        <Button Grid.Column="2" Text="ðŸ—‘" 
                                                Command="{Binding Source={x:Reference PageRoot}, Path=BindingContext.DeleteCategoryCommand}"
                                                CommandParameter="{Binding .}"
                                                BackgroundColor="Transparent" TextColor="#ef4444" WidthRequest="40"/>
                                    </Grid>
                                </Frame>
                            </DataTemplate>
                        </BindableLayout.ItemTemplate>
                    </VerticalStackLayout>
                </VerticalStackLayout>
            </ScrollView>
        </Grid>

        <!-- Loading Overlay -->
        <Grid Grid.RowSpan="3" BackgroundColor="Black" Opacity="0.5" IsVisible="{Binding IsLoading}">
            <ActivityIndicator IsRunning="{Binding IsLoading}" Color="#4f46e5" HorizontalOptions="Center" VerticalOptions="Center"/>
        </Grid>
    </Grid>
</ContentPage>
