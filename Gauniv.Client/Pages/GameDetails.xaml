<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:Gauniv.Client.ViewModel"
             x:Class="Gauniv.Client.Pages.GameDetails"
             Title="{Binding Game.Title, FallbackValue='DÃ©tails du jeu'}"
             x:DataType="vm:GameDetailsViewModel"
             BackgroundColor="#0a0c10"
             Shell.NavBarIsVisible="True">

    <ContentPage.ToolbarItems>
        <ToolbarItem Text="â† Retour" 
                     Command="{Binding GoBackCommand}"/>
    </ContentPage.ToolbarItems>

    <ScrollView BackgroundColor="#0a0c10">
        <VerticalStackLayout Padding="0" Spacing="0" BackgroundColor="#0a0c10">
            
            <!-- Loading Indicator -->
            <ActivityIndicator IsRunning="{Binding IsLoading}"
                              IsVisible="{Binding IsLoading}"
                              Color="#66c0f4"
                              HeightRequest="100"
                              VerticalOptions="Center"
                              Margin="0,50,0,0"/>

            <!-- Game Content -->
            <VerticalStackLayout Spacing="0" IsVisible="{Binding Game, Converter={StaticResource IsNotNullConverter}}">
                
                <!-- Hero Image -->
                <Border Padding="0"
                        StrokeThickness="0"
                        HeightRequest="300"
                        Margin="0">
                    <Image Source="{Binding Game.ImageUrl}"
                          Aspect="AspectFill"
                          HorizontalOptions="Fill"
                          VerticalOptions="Fill"/>
                </Border>

                <!-- Content -->
                <VerticalStackLayout Spacing="24" Padding="24">
                    
                    <!-- Header -->
                    <VerticalStackLayout Spacing="10">
                        <Label Text="{Binding Game.Title}"
                               FontSize="36"
                               FontAttributes="Bold"
                               TextColor="White"/>
                        
                        <Label Text="{Binding StatusMessage}"
                               FontSize="14"
                               TextColor="{StaticResource TextMuted}"
                               IsVisible="{Binding StatusMessage, Converter={StaticResource IsNotNullConverter}}"/>
                    </VerticalStackLayout>

                    <!-- Categories -->
                    <FlexLayout BindableLayout.ItemsSource="{Binding Game.Categories}"
                               Wrap="Wrap"
                               JustifyContent="Start">
                        <BindableLayout.ItemTemplate>
                            <DataTemplate x:DataType="x:String">
                                <Border Background="{StaticResource GlassBackgroundBrush}" Padding="12,4" Margin="0,0,8,8" StrokeThickness="1" Stroke="{StaticResource GlassBorderBrush}" StrokeShape="RoundRectangle 8">
                                    <Label Text="{Binding .}"
                                           FontSize="12"
                                           TextColor="{StaticResource Primary}"/>
                                </Border>
                            </DataTemplate>
                        </BindableLayout.ItemTemplate>
                    </FlexLayout>

                    <!-- Description -->
                    <Border Style="{StaticResource GlassCard}">
                        <VerticalStackLayout Spacing="12">
                            <Label Text="DESCRIPTION"
                                   FontSize="14"
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource TextMuted}"
                                   CharacterSpacing="2"/>
                            <Label Text="{Binding Game.Description}"
                                   FontSize="15"
                                   TextColor="{StaticResource TextMain}"
                                   LineBreakMode="WordWrap"/>
                        </VerticalStackLayout>
                    </Border>

                    <Border Style="{StaticResource GlassCard}">
                        <Border.Triggers>
                            <DataTrigger TargetType="Border" Binding="{Binding IsOwned}" Value="True">
                                <Setter Property="IsVisible" Value="False"/>
                            </DataTrigger>
                            <DataTrigger TargetType="Border" Binding="{Binding IsNotAdmin}" Value="False">
                                <Setter Property="IsVisible" Value="False"/>
                            </DataTrigger>
                        </Border.Triggers>
                        <VerticalStackLayout Spacing="15">
                            <Label Text="{Binding Game.Price, StringFormat='{0:C}'}"
                                   FontSize="28"
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource Accent}"/>
                            
                            <Button Text="ACHETER MAINTENANT"
                                    Command="{Binding PurchaseCommand}"
                                    BackgroundColor="{StaticResource Accent}"
                                    TextColor="Black"
                                    FontAttributes="Bold"
                                    FontSize="16"
                                    HeightRequest="56"/>
                        </VerticalStackLayout>
                    </Border>

                    <!-- Owned Section -->
                    <Border Style="{StaticResource GlassCard}">
                        <Border.Triggers>
                            <DataTrigger TargetType="Border" Binding="{Binding IsOwned}" Value="False">
                                <Setter Property="IsVisible" Value="False"/>
                            </DataTrigger>
                            <DataTrigger TargetType="Border" Binding="{Binding IsNotAdmin}" Value="False">
                                <Setter Property="IsVisible" Value="False"/>
                            </DataTrigger>
                        </Border.Triggers>
                        <VerticalStackLayout Spacing="15">
                            <HorizontalStackLayout Spacing="10">
                                <Label Text="âœ…"
                                       FontSize="24"
                                       VerticalOptions="Center"/>
                                <Label Text="VOUS POSSÃ‰DEZ CE JEU"
                                       FontSize="14"
                                       FontAttributes="Bold"
                                       TextColor="{StaticResource Accent}"
                                       VerticalOptions="Center"
                                       CharacterSpacing="2"/>
                            </HorizontalStackLayout>
                            
                            <VerticalStackLayout IsVisible="{Binding IsDownloading}" Spacing="5" Margin="0,0,0,10">
                                <Grid ColumnDefinitions="*,Auto">
                                    <Label Text="TÃ‰LÃ‰CHARGEMENT..." FontSize="10" TextColor="{StaticResource Primary}" CharacterSpacing="1"/>
                                    <Label Grid.Column="1" Text="{Binding DownloadProgress, StringFormat='{0:P0}'}" FontSize="12" TextColor="{StaticResource Primary}"/>
                                </Grid>
                                <ProgressBar Progress="{Binding DownloadProgress}" ProgressColor="{StaticResource Primary}" HeightRequest="4"/>
                            </VerticalStackLayout>

                            <Button Text="TÃ‰LÃ‰CHARGER"
                                    Command="{Binding DownloadCommand}"
                                    BackgroundColor="{StaticResource Primary}"
                                    TextColor="White"
                                    FontAttributes="Bold"
                                    FontSize="16"
                                    HeightRequest="50">
                                <Button.Triggers>
                                    <DataTrigger TargetType="Button" Binding="{Binding IsDownloaded}" Value="True">
                                        <Setter Property="IsVisible" Value="False"/>
                                    </DataTrigger>
                                    <DataTrigger TargetType="Button" Binding="{Binding IsDownloading}" Value="True">
                                        <Setter Property="IsEnabled" Value="False"/>
                                        <Setter Property="Opacity" Value="0.6"/>
                                    </DataTrigger>
                                </Button.Triggers>
                            </Button>
                            
                            <Button Text="ðŸŽ® JOUER"
                                    Command="{Binding PlayCommand}"
                                    BackgroundColor="{StaticResource Accent}"
                                    TextColor="Black"
                                    FontAttributes="Bold"
                                    FontSize="16"
                                    HeightRequest="50">
                                <Button.Triggers>
                                    <DataTrigger TargetType="Button" Binding="{Binding IsDownloaded}" Value="False">
                                        <Setter Property="IsVisible" Value="False"/>
                                    </DataTrigger>
                                    
                                    <DataTrigger TargetType="Button" Binding="{Binding CanPlay}" Value="False">
                                        <Setter Property="BackgroundColor" Value="#3d4450"/>
                                        <Setter Property="Text" Value="SESSION EN COURS"/>
                                        <Setter Property="Opacity" Value="0.5"/>
                                    </DataTrigger>

                                    <DataTrigger TargetType="Button" Binding="{Binding IsRunning}" Value="True">
                                        <Setter Property="BackgroundColor" Value="#ef4444"/>
                                        <Setter Property="Text" Value="ðŸ›‘ ARRÃŠTER"/>
                                        <Setter Property="Opacity" Value="1.0"/>
                                    </DataTrigger>
                                </Button.Triggers>
                            </Button>
                            
                            <Button Text="SUPPRIMER"
                                    Command="{Binding DeleteCommand}"
                                    BackgroundColor="Transparent"
                                    BorderColor="{StaticResource Primary}"
                                    BorderWidth="1"
                                    TextColor="{StaticResource Primary}"
                                    FontAttributes="Bold"
                                    FontSize="14"
                                    HeightRequest="44">
                                <Button.Triggers>
                                    <DataTrigger TargetType="Button" Binding="{Binding IsDownloaded}" Value="False">
                                        <Setter Property="IsVisible" Value="False"/>
                                    </DataTrigger>
                                </Button.Triggers>
                            </Button>
                        </VerticalStackLayout>
                    </Border>

                </VerticalStackLayout>
            </VerticalStackLayout>

            <!-- Empty State -->
            <VerticalStackLayout Padding="40"
                                Spacing="20"
                                VerticalOptions="Center"
                                IsVisible="{Binding Game, Converter={StaticResource IsNullConverter}}"
                                Margin="0,100,0,0">
                <Label Text="ðŸŽ®"
                       FontSize="80"
                       HorizontalOptions="Center"
                       TextColor="#66c0f4"/>
                <Label Text="Aucun jeu sÃ©lectionnÃ©"
                       FontSize="20"
                       FontAttributes="Bold"
                       TextColor="#c7d5e0"
                       HorizontalOptions="Center"/>
            </VerticalStackLayout>

        </VerticalStackLayout>
    </ScrollView>
</ContentPage>